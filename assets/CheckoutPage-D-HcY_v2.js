import{j as e,u as M,b as z,A as $,L as T}from"./index-ByxEemcU.js";import{r as d}from"./vendor-CIP6LD3P.js";import{E as O,l as R,u as I,a as V,C as L}from"./stripe-xoVoMAn3.js";const _=[{id:"MR01",name:"Tabac Le Khédive",address:"15 Place de l'Hôtel de ville",zip:"02100",city:"Saint-Quentin"},{id:"MR02",name:"Carrefour City",address:"55 Rue d'Isle",zip:"02100",city:"Saint-Quentin"},{id:"MR03",name:"Vivaldi Press",address:"8 Rue de la Sellerie",zip:"02100",city:"Saint-Quentin"}],q=({onClose:j,onSelect:g})=>e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4",onClick:j,children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl p-6 max-w-lg w-full max-h-[80vh] flex flex-col",onClick:a=>a.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-4 flex-shrink-0",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Choisissez un point de retrait"}),e.jsx("button",{onClick:j,"aria-label":"Fermer",children:e.jsx("svg",{className:"w-6 h-6 text-gray-600 hover:text-gray-900",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsx("div",{className:"overflow-y-auto space-y-3",children:_.map(a=>e.jsx("div",{className:"p-4 border rounded-lg hover:bg-teal-50 hover:border-teal-300 transition-colors",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-bold",children:a.name}),e.jsx("p",{className:"text-sm text-gray-600",children:a.address}),e.jsxs("p",{className:"text-sm text-gray-600",children:[a.zip," ",a.city]})]}),e.jsx("button",{onClick:()=>g(a),className:"bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-teal-700 text-sm",children:"Choisir"})]})},a.id))})]})}),D=R("pk_test_your_stripe_public_key_here"),B={iconStyle:"solid",style:{base:{iconColor:"#0d9488",color:"#374151",fontWeight:"500",fontFamily:"Poppins, sans-serif",fontSize:"16px",fontSmoothing:"antialiased",":-webkit-autofill":{color:"#fce883"},"::placeholder":{color:"#9ca3af"}},invalid:{iconColor:"#ef4444",color:"#ef4444"}}},F=[{name:"Colissimo Domicile",deliveryTime:"2-3 jours ouvrés",price:5.99},{name:"Chronopost Express",deliveryTime:"24h",price:12.5}],A=[{name:"Mondial Relay",deliveryTime:"3-5 jours ouvrés",price:4.5}],H=({onOrderPlaced:j,onAttemptSubmit:g})=>{const{currentUser:a,token:k}=M(),{cartItems:C,placeOrder:i,totalPrice:N}=z(),t=I(),p=V(),[S,y]=d.useState(!1),[n,v]=d.useState(null),[l,b]=d.useState("stripe"),[P,w]=d.useState(N);d.useEffect(()=>{var c;const h=parseFloat(((c=document.getElementById("shipping-cost"))==null?void 0:c.textContent)||"0");w(N+h)},[N]);const r=async h=>{var f;if(!t||!p||!k)throw new Error("Vérification Stripe ou informations de livraison manquantes.");const c=p.getElement(L);if(!c)throw new Error("Élément de carte Stripe non trouvé.");const m=await fetch("/api/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${k}`},body:JSON.stringify({items:C,shippingCost:((f=h.carrier)==null?void 0:f.price)??0})}),u=await m.json();if(!m.ok)throw new Error(u.error||"La création de l'intention de paiement a échoué.");const s=u.clientSecret;if(!s)throw new Error("Clé secrète client non reçue.");const{error:x,paymentIntent:o}=await t.confirmCardPayment(s,{payment_method:{card:c,billing_details:{name:h.address.name,email:a==null?void 0:a.email}}});if(x)throw new Error(x.message||"Une erreur inattendue est survenue avec Stripe.");if((o==null?void 0:o.status)!=="succeeded")throw new Error("Le paiement a échoué. Veuillez réessayer.")},E=async h=>{h.preventDefault();const{isValid:c,shippingDetails:m}=g();if(!c){v("Veuillez remplir tous les champs requis avant de continuer.");return}y(!0),v(null);try{l==="stripe"&&await r(m);const u=await i(m);j(u)}catch(u){v(u.message)}finally{y(!1)}};return e.jsxs("form",{onSubmit:E,className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xl font-bold mb-4",children:"Paiement"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{onClick:()=>b("stripe"),className:`p-4 border rounded-lg cursor-pointer ${l==="stripe"?"border-teal-500 ring-2 ring-teal-500":"border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"payment-method",value:"stripe",checked:l==="stripe",onChange:()=>{},className:"h-4 w-4 text-teal-600 border-gray-300"}),e.jsx("span",{className:"ml-3 text-sm font-medium",children:"Carte de crédit"})]}),l==="stripe"&&e.jsx("div",{className:"mt-4 pl-7",children:e.jsx(L,{options:B})})]}),e.jsx("div",{onClick:()=>b("paypal"),className:`p-4 border rounded-lg cursor-pointer ${l==="paypal"?"border-teal-500 ring-2 ring-teal-500":"border-gray-200"}`,children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"payment-method",value:"paypal",checked:l==="paypal",onChange:()=>{},className:"h-4 w-4 text-teal-600 border-gray-300"}),e.jsx("span",{className:"ml-3 text-sm font-medium",children:"PayPal"})]})})]})]}),n&&e.jsx("p",{className:"text-red-500 text-center text-sm",children:n}),e.jsx("button",{type:"submit",disabled:S||l==="stripe"&&(!t||!p),className:"w-full bg-yellow-400 text-gray-900 py-3 rounded-lg font-bold hover:bg-yellow-500 disabled:bg-gray-300 flex items-center justify-center h-12",children:S?e.jsx(T,{}):`Payer ${P.toFixed(2)} €`})]})},J=({onOrderPlaced:j,onBack:g})=>{const{currentUser:a}=M(),{cartItems:k,totalPrice:C}=z(),[i,N]=d.useState("home"),[t,p]=d.useState(F[0]),[S,y]=d.useState(!1),[n,v]=d.useState({name:(a==null?void 0:a.name)||"",line1:"",city:"",postalCode:"",country:"France"}),[l,b]=d.useState({name:!1,line1:!1,city:!1,postalCode:!1}),[P,w]=d.useState(!1),[r,E]=d.useState(null),h=C+((t==null?void 0:t.price)||0),c=s=>{N(s),b({name:!1,line1:!1,city:!1,postalCode:!1}),w(!1),s==="home"?(p(F[0]),E(null)):p(A[0])},m=s=>{const{id:x,value:o}=s.target;v(f=>({...f,[x]:o})),o.trim()&&b(f=>({...f,[x]:!1}))},u=()=>{let s=!1,x=null;if(i==="home"){const o={name:n.name.trim()==="",line1:n.line1.trim()==="",city:n.city.trim()==="",postalCode:n.postalCode.trim()===""};b(o),s=!Object.values(o).some(Boolean)&&!!t,s&&(x={type:"home",address:n,carrier:t})}else if(i==="pickup"){const o=!r;w(o),s=!o&&!!t,s&&(x={type:"pickup",address:{name:(a==null?void 0:a.name)||"",line1:r.address,city:r.city,postalCode:r.zip,country:"France"},pickupPoint:{id:r.id,name:r.name},carrier:t})}return{isValid:s,shippingDetails:x}};return e.jsxs("div",{className:"flex-grow bg-white animate-fade-in",children:[e.jsx("header",{className:"px-6 py-4 border-b shadow-sm",children:e.jsx("button",{onClick:g,className:"text-2xl font-bold text-gray-800 tracking-wider",children:"🛍️ CADORAMA - Paiement"})}),e.jsxs("div",{className:"max-w-4xl mx-auto p-4 sm:p-8 grid grid-cols-1 md:grid-cols-2 gap-12",children:[e.jsxs("div",{className:"md:col-span-1 space-y-8",children:[e.jsxs("section",{children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Méthode de livraison"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:`p-4 border rounded-lg ${i==="home"?"border-teal-500 ring-2 ring-teal-500":"border-gray-200"}`,children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:"shipping",value:"home",checked:i==="home",onChange:()=>c("home"),className:"h-4 w-4 text-teal-600 border-gray-300 focus:ring-teal-500"}),e.jsx("span",{className:"ml-3 text-sm font-medium",children:"Livraison à domicile"})]}),i==="home"&&e.jsx("div",{className:"mt-4 pl-7 space-y-3",children:F.map(s=>e.jsxs("label",{className:`flex items-center justify-between p-3 border rounded-md cursor-pointer ${(t==null?void 0:t.name)===s.name?"border-teal-400 bg-teal-50":"border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"carrier",value:s.name,checked:(t==null?void 0:t.name)===s.name,onChange:()=>p(s),className:"h-4 w-4 text-teal-600"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("p",{className:"text-sm font-semibold",children:s.name}),e.jsx("p",{className:"text-xs text-gray-500",children:s.deliveryTime})]})]}),e.jsxs("p",{className:"text-sm font-bold",children:[s.price.toFixed(2)," €"]})]},s.name))})]}),e.jsxs("div",{className:`p-4 border rounded-lg ${i==="pickup"?"border-teal-500 ring-2 ring-teal-500":"border-gray-200"}`,children:[e.jsxs("label",{className:"flex items-center cursor-pointer",children:[e.jsx("input",{type:"radio",name:"shipping",value:"pickup",checked:i==="pickup",onChange:()=>c("pickup"),className:"h-4 w-4 text-teal-600 border-gray-300 focus:ring-teal-500"}),e.jsx("span",{className:"ml-3 text-sm font-medium",children:"Livraison en point de retrait"})]}),i==="pickup"&&e.jsx("div",{className:"mt-4 pl-7 space-y-3",children:A.map(s=>e.jsxs("label",{className:`flex items-center justify-between p-3 border rounded-md cursor-pointer ${(t==null?void 0:t.name)===s.name?"border-teal-400 bg-teal-50":"border-gray-200"}`,children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"radio",name:"carrier",value:s.name,checked:(t==null?void 0:t.name)===s.name,onChange:()=>p(s),className:"h-4 w-4 text-teal-600"}),e.jsxs("div",{className:"ml-3",children:[e.jsx("p",{className:"text-sm font-semibold",children:s.name}),e.jsx("p",{className:"text-xs text-gray-500",children:s.deliveryTime})]})]}),e.jsxs("p",{className:"text-sm font-bold",children:[s.price.toFixed(2)," €"]})]},s.name))})]})]})]}),e.jsxs("section",{children:[i==="home"&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-xl font-bold",children:"Adresse de livraison"}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"name",className:"block text-sm font-medium text-gray-700",children:"Nom complet"}),e.jsx("input",{type:"text",id:"name",value:n.name,onChange:m,className:`mt-1 w-full p-2 border rounded-md ${l.name?"border-red-500":"border-gray-200"}`}),l.name&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"Le nom complet est requis."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"line1",className:"block text-sm font-medium text-gray-700",children:"Adresse"}),e.jsx("input",{type:"text",id:"line1",value:n.line1,onChange:m,className:`mt-1 w-full p-2 border rounded-md ${l.line1?"border-red-500":"border-gray-200"}`}),l.line1&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"L'adresse est requise."})]}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{htmlFor:"postalCode",className:"block text-sm font-medium text-gray-700",children:"Code Postal"}),e.jsx("input",{type:"text",id:"postalCode",value:n.postalCode,onChange:m,className:`mt-1 w-full p-2 border rounded-md ${l.postalCode?"border-red-500":"border-gray-200"}`}),l.postalCode&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"Le code postal est requis."})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{htmlFor:"city",className:"block text-sm font-medium text-gray-700",children:"Ville"}),e.jsx("input",{type:"text",id:"city",value:n.city,onChange:m,className:`mt-1 w-full p-2 border rounded-md ${l.city?"border-red-500":"border-gray-200"}`}),l.city&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"La ville est requise."})]})]})]}),i==="pickup"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Point de retrait"}),r?e.jsxs("div",{className:"border p-4 rounded-lg bg-teal-50 border-teal-200",children:[e.jsx("p",{className:"font-bold",children:r.name}),e.jsx("p",{className:"text-sm text-gray-600",children:r.address}),e.jsxs("p",{className:"text-sm text-gray-600",children:[r.zip," ",r.city]}),e.jsx("button",{onClick:()=>y(!0),className:"text-teal-600 hover:underline text-sm mt-2",children:"Changer"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>y(!0),className:`w-full text-gray-800 py-3 rounded-lg font-semibold transition-colors ${P?"bg-red-100 hover:bg-red-200 border border-red-500":"bg-gray-100 hover:bg-gray-200"}`,children:"Choisir un point de retrait"}),P&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"Veuillez choisir un point de retrait."})]})]})]}),e.jsx(O,{stripe:D,children:e.jsx(H,{onOrderPlaced:j,onAttemptSubmit:u})})]}),e.jsxs("div",{className:"md:col-span-1 bg-gray-50 p-6 rounded-lg self-start",children:[e.jsx("h3",{className:"text-xl font-bold border-b pb-4 mb-4",children:"Votre commande"}),e.jsx("div",{className:"space-y-4 max-h-64 overflow-y-auto pr-2",children:k.map(s=>e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx($,{product:s,loading:"lazy",className:"w-16 h-16 object-cover rounded-md"}),e.jsxs("div",{className:"flex-grow",children:[e.jsx("p",{className:"font-semibold text-sm",children:s.name}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Qté: ",s.quantity]})]}),e.jsxs("p",{className:"font-semibold text-sm",children:[(s.price*s.quantity).toFixed(2)," €"]})]},s.id))}),e.jsxs("div",{className:"border-t pt-4 mt-4 space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-gray-600",children:[e.jsx("span",{children:"Sous-total"}),e.jsxs("span",{children:[C.toFixed(2)," €"]})]}),e.jsxs("div",{className:"flex justify-between text-gray-600",children:[e.jsx("span",{children:"Livraison"}),e.jsxs("span",{id:"shipping-cost",children:[t?`${t.price.toFixed(2)}`:"0.00"," €"]})]}),e.jsxs("div",{className:"flex justify-between font-bold text-lg",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:[h.toFixed(2)," €"]})]})]})]})]}),S&&e.jsx(q,{onClose:()=>y(!1),onSelect:s=>{E(s),y(!1),w(!1)}})]})};export{J as default};
